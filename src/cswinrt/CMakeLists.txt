# CMake build for cswinrt.exe (the C#/WinRT code generator).
#
# This supports building natively on Windows with MinGW, or cross-building
# from Linux for Windows using a mingw-w64 toolchain:
#
#   cmake -S . -B build/ --toolchain ../../cross-mingw-toolchain.cmake \
#       -DCMAKE_BUILD_TYPE=RelWithDebInfo \
#       -DCMAKE_INSTALL_PREFIX=$PWD/install/
#   cmake --build build/ --target install -j$(nproc)
#
# The existing cswinrt.vcxproj / MSBuild flow is unaffected by this file.

cmake_minimum_required(VERSION 3.16)

project(cswinrt LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED True)

set(CSWINRT_BUILD_VERSION "0.0.0-private.0" CACHE STRING "The version string used for cswinrt.")
message(STATUS "Using version string: ${CSWINRT_BUILD_VERSION}")

if(WIN32)
    add_compile_definitions(_WIN32_WINNT=0x0602)
endif()


# === prebuild: Generator tool for strings.h, strings.cpp, version.rc ===

if(CMAKE_CROSSCOMPILING)
    include(ExternalProject)
    ExternalProject_Add(cswinrt-prebuild
        SOURCE_DIR "${PROJECT_SOURCE_DIR}/prebuild"
        CMAKE_ARGS
            -DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>
            "-DCSWINRT_BUILD_VERSION=${CSWINRT_BUILD_VERSION}"
    )
    ExternalProject_Get_Property(cswinrt-prebuild INSTALL_DIR)
    set(PREBUILD_TOOL "${INSTALL_DIR}/bin/cswinrt-prebuild")
    unset(INSTALL_DIR)
else()
    add_subdirectory(prebuild)
    set(PREBUILD_TOOL cswinrt-prebuild)
endif()


# === Step to create autogenerated files ===

file(GLOB_RECURSE PREBUILD_STRING_FILES
    LIST_DIRECTORIES false
    CONFIGURE_DEPENDS
    strings/*.cs
)
add_custom_command(
    OUTPUT
        ${PROJECT_BINARY_DIR}/strings.h
        ${PROJECT_BINARY_DIR}/strings.cpp
        ${PROJECT_BINARY_DIR}/version.rc
    COMMAND "${PREBUILD_TOOL}" ARGS "${PROJECT_SOURCE_DIR}/strings" "${PROJECT_BINARY_DIR}"
    DEPENDS
        cswinrt-prebuild
        ${PREBUILD_STRING_FILES}
    VERBATIM
)


# === cswinrt executable ===

set(CSWINRT_SRCS
    main.cpp
    "${PROJECT_BINARY_DIR}/strings.cpp"
)

set(CSWINRT_HEADERS
    pch.h
    cmd_reader.h
    code_writers.h
    concurrent_containers.h
    helpers.h
    settings.h
    task_group.h
    text_writer.h
    type_writers.h
)

if(WIN32)
    set(CSWINRT_RESOURCES
        "${PROJECT_BINARY_DIR}/version.rc"
    )
endif()

add_executable(cswinrt ${CSWINRT_SRCS} ${CSWINRT_RESOURCES} ${CSWINRT_HEADERS})
target_compile_definitions(cswinrt PRIVATE VERSION_STRING="${CSWINRT_BUILD_VERSION}" VERSION_NUMBER="0.0.0.0")
target_include_directories(cswinrt PRIVATE ${PROJECT_BINARY_DIR} ${PROJECT_SOURCE_DIR})

if(WIN32)
    target_link_libraries(cswinrt shlwapi advapi32)
endif()

install(TARGETS cswinrt)


# === winmd: External header-only library for reading winmd files ===

set(EXTERNAL_WINMD_INCLUDE_DIR "" CACHE PATH "Path to the include dir of the winmd library headers. Leave empty to download via ExternalProject.")

if(EXTERNAL_WINMD_INCLUDE_DIR STREQUAL "")
    message(STATUS "The winmd library will be downloaded using ExternalProject.")
    include(ExternalProject)
    ExternalProject_Add(winmd
        GIT_REPOSITORY https://github.com/microsoft/winmd.git
        GIT_TAG 0f1eae3bfa63fa2ba3c2912cbfe72a01db94cc5a
        CONFIGURE_COMMAND ""
        BUILD_COMMAND ""
        INSTALL_COMMAND ""
        UPDATE_COMMAND ""
    )
    add_dependencies(cswinrt winmd)
    ExternalProject_Get_Property(winmd SOURCE_DIR)
    set(winmd_INCLUDE_DIR "${SOURCE_DIR}/src")
else()
    message(STATUS "Using winmd library headers at ${EXTERNAL_WINMD_INCLUDE_DIR}")
    set(winmd_INCLUDE_DIR "${EXTERNAL_WINMD_INCLUDE_DIR}")
endif()
target_include_directories(cswinrt PRIVATE "${winmd_INCLUDE_DIR}")


# === xmllite import lib for MinGW ===

if(WIN32 AND MINGW)
    function(TestLinkXmlLite OUTPUT_VARNAME)
        include(CheckCXXSourceCompiles)
        set(CMAKE_REQUIRED_LIBRARIES xmllite)
        check_cxx_source_compiles("
#include <xmllite.h>
int main() {
    CreateXmlReader(__uuidof(IXmlReader), nullptr, nullptr);
}
        " ${OUTPUT_VARNAME})
    endfunction()

    function(TestIsI386 OUTPUT_VARNAME)
        include(CheckCXXSourceCompiles)
        check_cxx_source_compiles("
#if !defined(__i386__) && !defined(_M_IX86)
#  error Not i386
#endif
int main() {}
        " ${OUTPUT_VARNAME})
    endfunction()

    set(XMLLITE_LIBRARY xmllite)
    TestLinkXmlLite(HAS_LIBXMLLITE)
    if(NOT HAS_LIBXMLLITE)
        TestIsI386(TARGET_IS_I386)
        if(TARGET_IS_I386)
            set(XMLLITE_DEF_FILE xmllite_i386)
        else()
            set(XMLLITE_DEF_FILE xmllite)
        endif()
        include(CMakeFindBinUtils)
        add_custom_command(
            OUTPUT
                "${PROJECT_BINARY_DIR}/libxmllite.a"
            COMMAND "${CMAKE_DLLTOOL}" -k -d "${PROJECT_SOURCE_DIR}/mingw-support/${XMLLITE_DEF_FILE}.def" -l "${PROJECT_BINARY_DIR}/libxmllite.a"
            DEPENDS "${PROJECT_SOURCE_DIR}/mingw-support/${XMLLITE_DEF_FILE}.def"
            VERBATIM
        )
        add_custom_target(gen-libxmllite
            DEPENDS "${PROJECT_BINARY_DIR}/libxmllite.a"
        )
        set(XMLLITE_LIBRARY "${PROJECT_BINARY_DIR}/libxmllite.a")
        add_dependencies(cswinrt gen-libxmllite)
    endif()
    target_link_libraries(cswinrt "${XMLLITE_LIBRARY}")
endif()
